<div class="container mt-4">
  <h1 class="mb-4">Shopping Cart</h1>
  
  <% if flash[:alert] %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
  
  <hr>

  <% if @cart_items.any? %>
    <div class="row">
      <div class="col-lg-8">
        <% @cart_items.each do |cart_item| %>
          <% product = cart_item.product %>
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body">
              <div class="row">
                <!-- Product Image -->
                <div class="col-md-3 col-sm-4">
                  <div class="position-relative">
                    <% if product.image.attached? %>
                      <%= image_tag url_for(product.image),
                            class: "img-fluid object-fit-contain rounded",
                            style: "width: 100%; height: 200px;",
                            alt: product.name %>
                    <% else %>
                      <%= image_tag "placeholder.png",
                            class: "img-fluid object-fit-contain rounded",
                            style: "width: 100%; height: 200px;",
                            alt: "Placeholder" %>
                    <% end %>
                  </div>
                </div>

                <!-- Product Details -->
                <div class="col-md-6 col-sm-8">
                  <h5 class="card-title mb-2">
                    <%= product.name %>
                  </h5>

                  <p class="text-muted mb-3" style="font-size: 0.9rem;">
                    <%= truncate(product.description, length: 150) %>
                  </p>

                  <!-- Quantity Selector -->
                  <div class="d-flex align-items-center mb-3">
                    <% product = cart_item.product %>
                    <% max_quantity = product.stock_quantity %>
                    <% current_quantity = cart_item.quantity %>
                    
                    <%= form_with url: cart_cart_item_path(cart_item), method: :patch, local: true, class: "d-flex align-items-center" do |f| %>
                      <button type="submit" name="quantity_action" value="decrease" class="btn btn-outline-warning border-warning px-3 py-1" <%= 'disabled' if current_quantity <= 1 %>>
                        âˆ’
                      </button>
                      <input type="text" value="<%= current_quantity %>" class="form-control text-center mx-2" style="width: 60px; border-color: #ffc107;" readonly>
                      <button type="submit" name="quantity_action" value="increase" class="btn btn-outline-warning border-warning px-3 py-1" <%= 'disabled' if current_quantity >= max_quantity %>>
                        +
                      </button>
                    <% end %>
                    <% if current_quantity >= max_quantity %>
                      <small class="text-danger ms-2">Max available: <%= max_quantity %></small>
                    <% end %>
                  </div>

                  <!-- Action Links -->
                  <div class="d-flex flex-wrap gap-3">
                    <%= button_to "Delete", cart_cart_item_path(cart_item), method: :delete, class: "btn btn-link text-danger p-0 border-0", style: "text-decoration: none;" %>
                  </div>
                </div>

                <!-- Price Column -->
                <div class="col-md-3 text-md-end">
                  <h4 class="fw-bold mb-1">Rs <%= product.price %></h4>
                </div>
              </div>
            </div>
          </div>
          <hr>
        <% end %>
      </div>

      <!-- Order Summary -->
      <div class="col-lg-4">
        <div class="card shadow-sm sticky-top" style="top: 20px;">
          <div class="card-body">
            <h5 class="card-title mb-3">Order Summary</h5>
            
            <% subtotal = @cart_items.sum { |item| item.product.price * item.quantity } %>
            <% tax = subtotal * 0.18 %>
            <% shipping = 150 %>
            <% total = subtotal + tax + shipping %>

            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span>Rs <%= subtotal.round(2) %></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Tax:</span>
              <span>Rs <%= tax.round(2) %></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Shipping:</span>
              <span>Rs <%= shipping %></span>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-3">
              <strong>Total:</strong>
              <strong>Rs <%= total.round(2) %></strong>
            </div>

            <% if current_user %>
              <%= link_to "Proceed to Checkout", checkout_path, class: "btn btn-warning w-100 mb-2" %>
            <% else %>
              <%= link_to "Proceed to Checkout", login_path, class: "btn btn-warning w-100 mb-2" %>
            <% end %>
            <%= link_to "Continue Shopping", products_path, class: "btn btn-outline-secondary w-100" %>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="text-center py-5">
      <% if current_user %>
        <h3 class="text-muted mb-3">Your cart is empty</h3>
        <p class="text-muted mb-4">Add some products to get started!</p>
        <%= link_to "Browse Products", products_path, class: "btn btn-primary btn-lg" %>
      <% else %>
        <h3 class="text-muted mb-3">Your cart is empty</h3>
        <p class="text-muted mb-4">Please login to add products to your cart</p>
        <%= link_to "Login", login_path, class: "btn btn-primary btn-lg me-2" %>
        <%= link_to "Browse Products", products_path, class: "btn btn-outline-primary btn-lg" %>
      <% end %>
    </div>
  <% end %>
</div>
